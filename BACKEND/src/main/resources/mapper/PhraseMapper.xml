<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.happiness.budtree.domain.phrase.PhraseMapper">

    <insert id="savePhrase" parameterType="com.happiness.budtree.domain.phrase.DTO.request.PhraseRegisterRQ"
            useGeneratedKeys="true">

        INSERT INTO phrase (content)
        VALUES (#{content})

    </insert>

    <select id="getPhrase" resultType="com.happiness.budtree.domain.phrase.DTO.response.TodayPhrase">

        SELECT content, like_count FROM phrase
        WHERE DATE(created_date) = CURDATE()

    </select>

    <update id="updatePhrase" parameterType="int">

        UPDATE phrase SET like_count = #{totalLike}
        WHERE DATE(created_date) = CURDATE()

    </update>

    <!-- 해결(1) 1. 비관적 락 -->
    <select id="getPhraseId" resultType="Long">

        SELECT phrase_id FROM phrase
        WHERE DATE(created_date) = CURDATE() FOR UPDATE;

    </select>

    <!-- 해결(1) 3. 좋아요 총 개수 +1 증가 -->
    <update id="plusLikeCount" parameterType="Long">

        UPDATE phrase SET like_count = like_count + 1
        WHERE phrase_id = #{phrase_id};

    </update>

    <!-- 해결(2) 1. 오늘의 글귀 총아요 총 개수(like_count) 1 증가 -->
    <update id="updateLikeCount">

        UPDATE phrase
        SET like_count = like_count + 1
        WHERE DATE(created_date) = CURDATE();

    </update>
</mapper>